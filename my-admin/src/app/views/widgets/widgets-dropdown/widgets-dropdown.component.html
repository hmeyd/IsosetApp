<c-row class="g-4">
  <c-col sm="6" xl="3">
    <c-widget-stat-a color="primary" [title]="'Users'">
      <ng-template cTemplateId="widgetValueTemplate" ngPreserveWhitespaces>
        {{ listClients.length }}
        <span class="fw-normal" style="font-size: 12px;">
          (-12.4% <svg cIcon name="cilArrowBottom" size="sm"></svg>)
        </span>
      </ng-template>

      <ng-template cTemplateId="widgetActionTemplate">
        <c-dropdown alignment="end" variant="btn-group">
          <button [caret]="false" cButton cDropdownToggle class="p-0 text-white" color="transparent">
            <svg cIcon name="cilOptions"></svg>
          </button>

          <ul cDropdownMenu *ngIf="(isLoggedIn$ | async); else loggedOutMenu">
            <li>
              <button (click)="toggleModal()" cDropdownItem>
                <svg cIcon name="cilList" class="me-2"></svg> Voir la liste
              </button>
            </li>
            <li>
              <button (click)="toggleCreateModal()" cDropdownItem>
                <svg cIcon name="cilUser" class="me-2"></svg> Créer un client
              </button>
            </li>
          </ul>

          <ng-template #loggedOutMenu>
            <ul cDropdownMenu class="py-2 shadow-lg border-0">
              <li class="px-3 py-2">
                <div class="d-flex align-items-center p-2 rounded-3 bg-light border border-warning-subtle">
                  <svg cIcon name="cilShieldAlt" class="text-warning me-2" size="sm"></svg>
                  <small class="text-muted fw-bold">Accès Restreint</small>
                </div>
              </li>

            </ul>
          </ng-template>
        </c-dropdown>
      </ng-template>

      <ng-template cTemplateId="widgetChartTemplate">
        <c-chart [data]="data[0]" [options]="options[0]" class="mt-3 mx-3" height="70" [type]="'line'" />
      </ng-template>
    </c-widget-stat-a>
  </c-col>

  <c-col sm="6" xl="3">
    <c-widget-stat-a [title]="'Commande'" color="info">
      <ng-template cTemplateId="widgetValueTemplate" ngPreserveWhitespaces>
        <span>{{ listCommandes.length }}</span>
        <span class="fw-normal" style="font-size: 12px;">
          (40.9%<svg cIcon name="cilArrowTop" size="sm"></svg>)
        </span>
      </ng-template>
      <ng-template cTemplateId="widgetActionTemplate">
        <c-dropdown alignment="end" variant="btn-group">
          <button [caret]="false" cButton cDropdownToggle class="p-0 text-white" color="transparent">
            <svg cIcon name="cilOptions"></svg>
          </button>
          <ul cDropdownMenu>
            <li>
              <button (click)=" toggleCommandeModal()" cDropdownItem>
                <svg cIcon name="cilList" class="me-2"></svg> Voir la liste
              </button>
            </li>
            <li>
              <button (click)="toggleCreateCommandeModal()" cDropdownItem>
                <svg cIcon name="cilUser" class="me-2"></svg> Créer un commande
              </button>
            </li>
          </ul>
        </c-dropdown>
      </ng-template>
      <ng-template cTemplateId="widgetChartTemplate">
        <c-chart [data]="data[1]" [options]="options[1]" class="mt-3 mx-3" height="70" type="line" />
      </ng-template>
    </c-widget-stat-a>
  </c-col>

  <c-col sm="6" xl="3">
    <c-widget-stat-a [title]="'Conversion Rate'" color="warning">
      <ng-template cTemplateId="widgetValueTemplate" ngPreserveWhitespaces>
        <span>2.49</span>
        <span class="fw-normal" style="font-size: 12px;">
          (84.7% <svg cIcon name="cilArrowTop" size="sm"></svg>)
        </span>
      </ng-template>
      <ng-template cTemplateId="widgetActionTemplate">
        <c-dropdown alignment="end" variant="btn-group">
          <button [caret]="false" cButton cDropdownToggle class="p-0 text-white" color="transparent">
            <svg cIcon name="cilOptions"></svg>
          </button>
          <ul cDropdownMenu>
            <li><a [routerLink]="[]" cDropdownItem>Action</a></li>
          </ul>
        </c-dropdown>
      </ng-template>
      <ng-template cTemplateId="widgetChartTemplate">
        <c-chart [data]="data[2]" [options]="options[2]" class="mt-3" height="70" type="line" />
      </ng-template>
    </c-widget-stat-a>
  </c-col>

  <c-col sm="6" xl="3">
    <c-widget-stat-a [title]="'Sessions'" color="danger">
      <ng-template cTemplateId="widgetValueTemplate" ngPreserveWhitespaces>
        <span>44K</span>
        <span class="fw-normal" style="font-size: 12px;">
          (-23.6% <svg cIcon name="cilArrowBottom" size="sm"></svg>)
        </span>
      </ng-template>
      <ng-template cTemplateId="widgetActionTemplate">
        <c-dropdown alignment="end" variant="btn-group">
          <button [caret]="false" cButton cDropdownToggle class="p-0 text-white" color="transparent">
            <svg cIcon name="cilOptions"></svg>
          </button>
          <ul cDropdownMenu>
            <li><a [routerLink]="[]" cDropdownItem>Action</a></li>
          </ul>
        </c-dropdown>
      </ng-template>
      <ng-template cTemplateId="widgetChartTemplate">
        <c-chart [data]="data[3]" [options]="options[3]" class="mt-3 mx-3" height="70" type="bar" />
      </ng-template>
    </c-widget-stat-a>
  </c-col>
</c-row>
<!---------------------modale de liste client ------------------------>
<c-modal id="clientModal" [visible]="visible" (visibleChange)="visible = $event" size="xl" backdrop="static"
  class="full-scroll-modal">
  <c-modal-header class="bg-primary text-white py-2">
    <h5 cModalTitle class="m-0 fs-6">
      <svg cIcon name="cilUser" class="me-2"></svg>
      Répertoire des Clients ({{ listClients.length }})
    </h5>
    <button type="button" (click)="toggleModal()" cButtonClose aria-label="Fermer" class="btn-close-white"></button>
  </c-modal-header>

  <c-modal-body class="body-scroll-container p-0">
    <table cTable hover striped class="align-middle m-0 table-sm text-center">
      <thead class="table-light">
        <tr>
          <th class="sticky-header small">Photo</th>
          <th class="sticky-header small">Nom</th>
          <th class="sticky-header small">Prénom</th>
          <th class="sticky-header small">Email</th>
          <th class="sticky-header small">Téléphone</th>
          <th class="sticky-header small">Adresse</th>
          <th class="sticky-header small">Création</th>
          <th class="sticky-header small">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let client of listClients">
          <ng-container *ngIf="client.nom">
            <td>
              <ng-container *ngIf="client.imagePath; else noImage">
                <img [src]="'http://localhost:59082' + client.imagePath" alt="Photo"
                  class="rounded-circle border border-primary border-2 shadow-sm"
                  style="width: 45px; height: 45px; object-fit: cover;" (error)="client.imagePath = null">
              </ng-container>
              <ng-template #noImage>
                <div
                  class="rounded-circle border border-secondary d-flex align-items-center justify-content-center bg-light mx-auto"
                  style="width: 45px; height: 45px;">
                  <svg cIcon name="cilUser" size="sm" class="text-secondary"></svg>
                </div>
              </ng-template>
            </td>
            <td class="fw-bold small">{{ client.nom }}</td>
            <td class="small">{{ client.prenom }}</td>
            <td class="small"><code class="text-primary">{{ client.email }}</code></td>
            <td class="small text-nowrap">{{ client.telephone }}</td>
            <td class="small text-truncate" style="max-width: 150px;">{{ client.adresse }}</td>
            <td class="small">{{ client.dateCreation | date:'dd/MM/yy' }}</td>
            <td>
              <div class="d-flex gap-1 justify-content-center">
                <button (click)="updateClient(client.id, client)" cButton color="secondary" variant="outline"
                  class="btn-xs-custom">
                  Modifier
                </button>
                <button (click)="deleteClient(client.id)" cButton color="danger" variant="outline"
                  class="btn-xs-custom">Supprimer</button>
              </div>
            </td>
          </ng-container>
        </tr>
      </tbody>
    </table>
  </c-modal-body>
  <c-modal-footer class="py-1">
    <button (click)="toggleModal()" cButton color="primary" variant="outline" class="btn-sm">Fermer</button>
  </c-modal-footer>
</c-modal>
<!--------------------Modale 2------------------------->
<c-modal id="createClientModal" [visible]="visibleCreate" (visibleChange)="visibleCreate = $event" backdrop="static"
  alignment="center" class="custom-square-modal">
  <c-modal-header class="bg-primary text-white border-0 py-3">
    <h5 cModalTitle class="w-100 text-center fw-bold m-0">Nouveau Client</h5>
    <button type="button" (click)="toggleCreateModal()" cButtonClose class="btn-close-white"></button>
  </c-modal-header>

  <c-modal-body class="p-4 bg-white">
    <form class="row g-3">
      <div class="col-12 d-flex flex-column align-items-center mb-4">
        <div class="rounded-circle border border-primary border-4 shadow-sm mb-3"
          style="width: 140px; height: 140px; overflow: hidden; background-color: #f8f9fa;">
          <img [src]="imagePreview ? imagePreview : 'assets/img/avatars/default-user.png'"
            style="width: 100%; height: 100%; object-fit: cover;">
        </div>
        <div class="w-75">
          <label cLabel class="fw-bold text-primary small d-block text-center" style="margin-bottom: 20px;">Photo de
            profil</label>
          <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*"
            class="form-control form-control-sm border-primary shadow-sm">
        </div>
      </div>

      <div class="col-md-6">
        <label cLabel class="fw-semibold d-block" style="margin-bottom: 10px;">Nom</label>
        <input cFormControl [(ngModel)]="newClient.nom" name="nom" placeholder="Ex: Dupont"
          class="border-primary shadow-sm form-control-sm" />
      </div>
      <div class="col-md-6">
        <label cLabel class="fw-semibold d-block" style="margin-bottom: 10px;">Prénom</label>
        <input cFormControl [(ngModel)]="newClient.prenom" name="prenom" placeholder="Ex: Jean"
          class="border-primary shadow-sm form-control-sm" />
      </div>
      <div class="col-md-6">
        <label cLabel class="fw-semibold d-block" style="margin-bottom: 10px;">Email</label>
        <input cFormControl [(ngModel)]="newClient.email" name="email" type="email" placeholder="exemple@mail.com"
          class="border-primary shadow-sm form-control-sm" />
      </div>
      <div class="col-md-6">
        <label cLabel class="fw-semibold d-block" style="margin-bottom: 10px;">Téléphone</label>
        <input cFormControl [(ngModel)]="newClient.telephone" name="telephone" placeholder="Ex: +33 6..."
          class="border-primary shadow-sm form-control-sm" />
      </div>
      <div class="col-12 mt-2">
        <label cLabel class="fw-semibold d-block" style="margin-bottom: 10px;">Adresse</label>
        <textarea cFormControl rows="2" [(ngModel)]="newClient.adresse" name="adresse"
          placeholder="Rue, Ville, Code Postal..." class="border-primary shadow-sm w-100 form-control-sm"
          style="resize: none;"></textarea>
      </div>
    </form>
  </c-modal-body>

  <c-modal-footer class="border-0 pb-4 bg-white d-flex justify-content-center">
    <button (click)="toggleCreateModal()" cButton color="secondary" variant="ghost" class="px-4">Annuler</button>
    <button (click)="saveClient(fileInput)" cButton color="primary" class="px-5 shadow-sm">Confirmer</button>
  </c-modal-footer>
</c-modal>

<!--------------------- modale de liste commande ------------------------>

<c-modal id="commandeModal" [visible]="visibleCommandeModal" (visibleChange)="visibleCommandeModal = $event"
  backdrop="static" alignment="center" class="custom-modal-container">

  <c-modal-header class="bg-primary text-white py-2">
    <h5 cModalTitle class="m-0 fs-6">
      <svg cIcon name="cilCart" class="me-2"></svg>
      Répertoire des Commandes ({{ listCommandes.length }})
    </h5>
    <button type="button" (click)="toggleCommandeModal()" cButtonClose class="btn-close-white"></button>
  </c-modal-header>

  <c-modal-body class="body-scroll-container bg-light p-4">
    <div class="d-flex flex-wrap justify-content-center gap-4">

      <div *ngFor="let cmd of listCommandes" class="card shadow-sm border-0"
        style="width: 280px; border-radius: 15px; overflow: hidden; background: white;">

        <div
          style="width: 100%; height: 200px; position: relative; background-color: #f8f9fa; border-bottom: 1px solid #eee;">

          <span [ngClass]="{
        'badge bg-success': cmd.statut === 'Livré' || cmd.statut === 'Payé',
        'badge bg-warning text-dark': cmd.statut === 'En cours' || cmd.statut === 'En attente',
        'badge bg-danger': cmd.statut === 'Annulé'
      }" class="position-absolute top-0 end-0 m-2 shadow-sm" style="z-index: 2;">
            {{ cmd.statut }}
          </span>

          <ng-container *ngIf="cmd.photo; else noImageTemplate">
            <img [src]="imagePreview || getPhotoUrl(newCommande.photo)"
       (error)="updateToDefault($event)"
       style="width: 100%; height: 100%; object-fit: cover;"
       alt="Photo">
          </ng-container>

          <ng-template #noImageTemplate>
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted bg-light">
              <svg cIcon name="cilImage" size="xl" class="opacity-50"></svg>
              <small class="mt-2 fw-semibold" style="font-size: 0.75rem;">Photo non disponible</small>
            </div>
          </ng-template>

        </div>

        <div class="p-3">
          <div class="mb-1">
            <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Référence</small>
            <h6 class="mb-0 text-truncate fw-bold">{{ cmd.numeroCommande }}</h6>
          </div>

          <div class="d-flex justify-content-between align-items-center my-2">
            <div class="text-primary fw-bolder fs-5">
              {{ cmd.montantTotal | currency:'EUR':'symbol':'1.2-2' }}
            </div>
            <small class="text-muted small">
              <svg cIcon name="cilCalendar" size="sm"></svg> {{ cmd.dateCommande | date:'dd/MM/yy' }}
            </small>
          </div>

          <hr class="my-2 opacity-25">

          <div class="d-flex align-items-center mb-3">
            <div class="me-2 shadow-sm" style="width: 35px; height: 35px; flex-shrink: 0;">
              <div class="me-2 shadow-sm" style="width: 35px; height: 35px; flex-shrink: 0;">
                <ng-container *ngIf="getClientPhoto(cmd.clientId) as clientImg; else noClientImg">
                  <img [src]="clientImg" class="rounded-circle border border-2 border-white"
                    style="width: 100%; height: 100%; object-fit: cover;">
                </ng-container>

                <ng-template #noClientImg>
                  <div class="bg-light rounded-circle d-flex align-items-center justify-content-center border h-100">
                    <svg cIcon name="cilUser" size="sm" class="text-secondary"></svg>
                  </div>
                </ng-template>
              </div>
            </div>
            <small class="fw-semibold text-dark">Client #{{ cmd.clientId }}</small>
          </div>

          <div class="d-flex gap-2">
            <button (click)="updateCommande(cmd.id, cmd)"
              class="btn btn-outline-secondary btn-sm flex-grow-1 border-0 bg-light">
              <svg cIcon name="cilPencil" size="sm"></svg> Éditer
            </button>
            <button (click)="deleteCommande(cmd.id)" class="btn btn-outline-danger btn-sm px-3 border-0 bg-light">
              <svg cIcon name="cilTrash" size="sm"></svg>
            </button>
          </div>
        </div>
      </div>

    </div>
  </c-modal-body>

  <c-modal-footer class="py-1">
    <button (click)="toggleCommandeModal()" cButton color="primary" variant="outline" class="btn-sm">Fermer</button>
  </c-modal-footer>
</c-modal>

<!------------------------créer une commande-------------------------->
<c-modal id="createCommandeModal" [visible]="visibleCreateCommande" (visibleChange)="visibleCreateCommande = $event"
  backdrop="static" alignment="center" class="custom-square-modal">

  <c-modal-header class="bg-primary text-white border-0 py-3">
    <h5 cModalTitle class="w-100 text-center fw-bold m-0">
      {{ newCommande.id ? 'Modifier la Commande' : 'Nouvelle Commande' }}
    </h5>
    <button type="button" (click)="toggleCreateCommandeModal()" cButtonClose class="btn-close-white"></button>
  </c-modal-header>

  <c-modal-body class="p-4 bg-white">
    <form class="row g-3">
      <div class="col-12 d-flex flex-column align-items-center mb-4">
        <div class="rounded border border-primary border-4 shadow-sm mb-3"
             style="width: 140px; height: 140px; overflow: hidden; background-color: #f8f9fa;">
          
          <ng-container *ngIf="imagePreview || newCommande.photo; else noOrderImage">
            <img [src]="imagePreview ? imagePreview : ('http://localhost:59082' + (newCommande.photo.startsWith('/') ? '' : '/') + newCommande.photo)"
                 style="width: 100%; height: 100%; object-fit: cover;"
                 (error)="imagePreview = null; newCommande.photo = null">
          </ng-container>

          <ng-template #noOrderImage>
            <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-light">
              <svg cIcon name="cilClipboard" size="xl" class="text-secondary" style="width: 60px; height: 60px;"></svg>
            </div>
          </ng-template>
        </div>

        <div class="w-75">
          <label cLabel class="fw-bold text-primary small d-block text-center" style="margin-bottom: 10px;">
            Photo du produit
          </label>
          <input type="file" #fileInputCommande (change)="onFileSelected($event)" accept="image/*"
                 class="form-control form-control-sm border-primary shadow-sm">
        </div>
      </div>

      <div class="col-md-6">
        <label cLabel class="fw-semibold d-block" style="margin-bottom: 8px;">N° Commande</label>
        <input cFormControl [(ngModel)]="newCommande.numeroCommande" name="numeroCommande"
          placeholder="Ex: CMD-2024-001" class="border-primary shadow-sm form-control-sm" />
      </div>

      <div class="col-md-6">
        <label cLabel class="fw-semibold d-block" style="margin-bottom: 8px;">Date</label>
        <input cFormControl [(ngModel)]="newCommande.dateCommande" name="dateCommande" type="date"
          class="border-primary shadow-sm form-control-sm" />
      </div>

      <div class="col-md-6">
        <label cLabel class="fw-semibold d-block" style="margin-bottom: 8px;">Montant Total (€)</label>
        <input cFormControl [(ngModel)]="newCommande.montantTotal" name="montantTotal" type="number" placeholder="0.00"
          class="border-primary shadow-sm form-control-sm" />
      </div>

      <div class="col-md-6">
        <label cLabel class="fw-semibold d-block" style="margin-bottom: 8px;">Statut</label>
        <select cSelect [(ngModel)]="newCommande.statut" name="statut" class="border-primary shadow-sm form-control-sm">
          <option value="">-- Choisir --</option>
          <option value="En attente">En attente</option>
          <option value="En cours">En cours</option>
          <option value="Livré">Livré</option>
          <option value="Annulé">Annulé</option>
        </select>
      </div>

      <div class="col-12 mt-2">
        <label cLabel class="fw-semibold d-block" style="margin-bottom: 8px;">ID Client (Propriétaire)</label>
        <input cFormControl [(ngModel)]="newCommande.clientId" name="clientId" type="number" placeholder="Ex: 1"
          class="border-primary shadow-sm form-control-sm" />
      </div>
    </form>
  </c-modal-body>

  <c-modal-footer class="border-0 pb-4 bg-white d-flex justify-content-center">
    <button (click)="toggleCreateCommandeModal()" cButton color="secondary" variant="ghost"
      class="px-4">Annuler</button>
    <button (click)="saveCommande(fileInputCommande)" cButton color="primary" class="px-5 shadow-sm">
      {{ newCommande.id ? 'Mettre à jour' : 'Enregistrer' }}
    </button>
  </c-modal-footer>
</c-modal>